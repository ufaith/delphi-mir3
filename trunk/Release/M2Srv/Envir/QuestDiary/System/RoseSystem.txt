;;EI3G-ÍøÓÎÏÈ·æ´«Ææ3ÉÌÒµ°æ±¾-´¿1.45EI°æ
;------------------------------------------------------------------------
;; Àå¹Ì¸¦ ¸¸µå´Â ·çÆ¾
;; D0 Àå¹ÌÀÇ Ã³À½ ±¸ÀÔ °ªÀ» Àû¾î µÎ´Â °÷
;; D1 Àå¹ÌÀÇ DB Àå¹Ì ¾ÆÀÌÅÛÀÇ ¼öÄ¡ °ªÀ» ¾ò¾î¿È
;; D2 Àå¹ÌÀÇ ±¸ÀÔ ¿©ºÎ¸¦ È®ÀÎ ÇÏ´Â °ªÀ» ¾ò¾î¿È(0:±¸ÀÔÀü,1:±¸ÀÔÁß,2:±¸ÀÔÃ³¸®,3:Æ÷ÀÎÆ®¸ðÀÚ¸§)
;; D3 ÀÐ¾î ¿À´Â ºÎºÐ¿¡¼­ ³Ê¹« ¸¹ÀÌ °É¸®Áö ¾ÊÀ» °æ¿ì
;; D4 ¾ÆÀÌÅÛÀÇ °¹¼ö¸¦ ³Ö´Â ºÎºÐ
;; A0 whereÀýÀÇ °Ë»ö ¾ÆÀÌµð¸¦ ´ã¾Æ µÎ´Â º¯¼ö
;; A1 Ã³À½ DBÀúÀåÀ» À§ÇÑ Ç® ¼¾ÅÙ½º¸¦ ´ã¾Æ µÎ´Â ºÎºÐ
;; A2 ÁÖ´Â ¾ÆÀÌÅÛÀÇ ÀÌ¸§À» ¼¼ÆÃ ÇÏ´Â ºÎºÐ
;; A8 DBÀÇ À¯Àú ¾ÆÀÌµð¸¦ ¾ò¾î ¿À´Â º¯¼ö
;; A9 ´Ù¿ëµµ·Î »ç¿ëÇÏ´Â ÀÓ½Ã¿ë º¯¼ö
;------------------------------------------------------------------------
[@Rose_System]
{
   #IF
   #ACT
      loadvalue D0   "GM_Def\QuestDiary\System\RoseSystem.txt" [RoseSystem] [SetPoint]
      loadvalue A2   "GM_Def\QuestDiary\System\RoseSystem.txt" [RoseSystem] [GiveItemName]
      loadvalue D4   "GM_Def\QuestDiary\System\RoseSystem.txt" [RoseSystem] [GiveItemmNum]
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_1

[@DB_Connect]
   #IF
   #ACT
      FormatStr "FLD_USERID='%s'" %USERID
      ReadValueSql  "TBL_RELATPOINT"  %A9  "FLD_USERID,FLD_POINT,FLD_OK"  [@Point_Loading]
      close
            
[@Point_Loading()]
   #IF
   #ACT
      mov       A8   %ARG(1)   ;; À¯ÀúÀÇ ÀÌ¸§À» ¾ò¾î ¿À´Â ºÎºÐ
      mov       D1   %ARG(2)   ;; DB ¼¼ÆÃ µÇ¾î ÀÖ´Â À¯ÀúÀÇ Æ÷ÀÎÆ®°ªÀ» ¾ò¾î¿È
      mov       D2   %ARG(3)   ;; ±¸ÀÔÇß´ÂÁö Ã¼Å© ÇÏ´Â ±¸¹®
      FormatStr "FLD_USERID='%s'" %USERID  ;; A9¿¡ À¯ÀúÀÇ ¾ÆÀÌµð °ªÀÌ µé¾î°¨
      mov       A0   %A9

   #IF
      IsAdmin
   #SAY
      {FCOLOR=249}DBÄÉ¸¯ÅÍÀúÀåÀÌ¸§ = <$OUTPUT(A8)> \ \
      ½ºÅ©¸³Æ®Æ÷ÀÎÆ® = <$OUTPUT(D0)> \ \
      DB ÀúÀå»è°¨Æ÷ÀÎÆ® = <$OUTPUT(D1)> \
      DB Àå¹Ì Çö»óÅÂ = <$OUTPUT(D2)>{FCOLOR=255} \ \

   #IF                         ;; Áß°£¿¡ Á¢¼ÓÀ» ²÷´Â °æ¿ì³ª ¿À·ù°¡ ³­°æ¿ì
      !Equal    A8   ""        ;; DB¿¡ ¾øÀ» °æ¿ì
      equal     D2   1         ;; ±¸ÀÔ Ã³¸®Àü »óÅÂ ÀÏ°æ¿ì
   #ACT
      UpdateValueSql "TBL_RELATPOINT" %A0 "FLD_OK=0"
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_2

   #IF                         ;; Áß°£¿¡ Á¢¼ÓÀ» ²÷´Â °æ¿ì³ª ¿À·ù°¡ ³­°æ¿ì
      !Equal    A8   ""        ;; Ã³À½ ±¸ÀÔÇÏÁö ¾Ê°í..
      equal     D2   2         ;; ±¸ÀÔ Ã³¸® ÈÄ Ã³¸®°¡ µÇÁö ¾ÊÀ» °æ¿ì
   #ACT
      give      %A2  %D4       ;; ¿ÜºÎÀûÀ¸·Î ¼¼ÆÃ ÇÏ°Ô ÇÔ
      UpdateValueSql "TBL_RELATPOINT" %A0 "FLD_OK=0"
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_2_except1

   #IF                         ;; Áß°£¿¡ Á¢¼ÓÀ» ²÷´Â °æ¿ì³ª ¿À·ù°¡ ³­°æ¿ì
      !Equal    A8   ""        ;; Ã³À½ ±¸ÀÔÇÏÁö ¾Ê°í..
      equal     D2   3         ;; Æ÷ÀÎÆ®°¡ ¸ðÀß¶ó ±¸ÀÔÀ» ÇÒ¼ö ¾øÀ» °æ¿ì
   #ACT
      UpdateValueSql "TBL_RELATPOINT" %A0 "FLD_OK=0"
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_2_except2

   #IF                         ;; °ªÀÌ ´Ù¸¦ °æ¿ì´Â ÃÊ±â°ªÀ» ¾÷µ¥ÀÌÆ® ½ÃÅ´
      !Equal    A8   ""
      !Equal    D1   %D0
   #ACT
      FormatStr "FLD_POINT='%s'" %D0
      UpdateValueSql "TBL_RELATPOINT" %A0 %A9
      
   #IF                        ;; ±¸ÀÔ ÁßÀÏ¶§´Â ÇÒ¼ö°¡ ¾øÀ½
      !Equal    D2   0        ;; ±¸ÀÔ Àü »óÅÂ ÀÌ¾î¾ß¸¸ ±¸ÀÔÀÌ °¡´É(¸ÖÆ¼ Ã¼Å© ±¸¹®)
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_3
   #ACT
      break

   #IF                        ;; Ã³À½ ÇÏ´Â ÇüÅÂ¿¡¼­ È®ÀÎ
      Equal  A8   ""          ;; Ã³À½ÇÑ°Å¶ó¸é ÀÎ¼­Æ® ÇüÅÂ·Î µ¹¾Æ°¨
   #ACT
      FormatStr "'%s'" %USERID     ;; FormatStr 3°³ ÀÌ»óÀÇ ÀÎÀÚ´Â µÇÁö ¾ÊÀ½
      mov A1 %A9
      FormatStr ",%s,%s,%s" %D0 0 1
      AddStr A1 %A9
      WriteValueSql  "TBL_RELATPOINT" %A0 "FLD_USERID,FLD_POINT,FLD_CURRENTPOINT,FLD_OK" %A1
      mov       D3   0        ;; ¹«ÇÑ ·çÇÁ¸¦ °Ë»ö ÇÏ´Â º¯¼ö
      goto @ResultCheck
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_4
   #ELSEACT
      UpdateValueSql "TBL_RELATPOINT" %A0 "FLD_OK=1"
      mov       D3   0        ;; ¹«ÇÑ ·çÇÁ¸¦ °Ë»ö ÇÏ´Â º¯¼ö
      goto @ResultCheck
      break
   #ELSESAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_5

[@ResultCheck]
   #ACT
      ReadValueSql  "TBL_RELATPOINT"  %A0  "FLD_OK"  [@ResultCheck_Confirm]
      break

[@ResultCheck_Confirm()]
   #ACT
      mov     D2    %ARG(1)    ;; ÇöÁ¦ »óÅÂ¸¦ ÀÐ¾î ¿À´Â ºÎºÐ

   #IF
      Equal   D2     0
   #ACT
      break                    ;; ÀÇµµÇÏÁö ¾Ê´Â ·çÆ¾ÀÌ µé¾î ¿ÔÀ» °æ¿ì

   #IF
      Equal   D2     2
   #ACT
      FormatStr "FLD_USERID='%s'" %USERID
      UpdateValueSql "TBL_RELATPOINT" %A9 "FLD_OK=0"    ;; ±¸ÀÔÀ» ÇßÀ¸¹Ç·Î ÃÊ±âÈ­ ½ÃÅ´
      give      %A2  %D4       ;; ¿ÜºÎÀûÀ¸·Î ¼¼ÆÃ ÇÏ°Ô ÇÔ
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_6

   #IF
      Equal   D2     3
   #ACT
      FormatStr "FLD_USERID='%s'" %USERID
      UpdateValueSql "TBL_RELATPOINT" %A9 "FLD_OK=0" ;;ÃÊ±âÈ­
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_6_except

   #IF
      Large   D3     5     ;; 15ÃÊ°¡ Áö³µÀ» °æ¿ì
   #ACT
      FormatStr "FLD_USERID='%s'" %USERID
      UpdateValueSql "TBL_RELATPOINT" %A9 "FLD_OK=0"    ;; ÃÊ±âÈ­ ½ÃÅ´
      break
   #SAY
      #INCLUDE [..\Convert_Def\QuestDiary\System\RoseSystem.txt] @RoseSystem_Say_7
      break

   #IF
   #ACT
      inc     D3     1                      ;; SQLÀ» Ã³¸® ÇÒ‹š ±îÁöÀÇ ½Ã°£À» ±â´Ù¸°´Ù.
      Delaygoto [Grobal] 3 @ResultCheck
}
